<!doctype html>
<html lang="es">
  <!-- ...existing code... -->
<div style="display:none" id="mobileLanguageSelector">
  <div style="text-align:right;padding:8px 12px">
    <select id="langSelectorMobile" style="padding:4px 8px;border-radius:4px;border:1px solid #e6e9ef;background:#fff;cursor:pointer;font-size:14px">
      <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      <option value="en">ðŸ‡¬ðŸ‡§ English</option>
    </select>
  </div>
</div>

  <div class="container">
    <header id="banner" style="width:1136px; height:360px; border-radius:10px; background:#001f3f; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; margin:0 auto;">
      <div class="banner-preview" id="bannerPreview" style="width:1136px; height:360px; background-size:contain; background-position:center; background-repeat:no-repeat; opacity:1; background-image:url('banner.jpeg'); position:relative;"></div>
      <!-- Frase eliminada, solo imagen visible en el banner -->
      <div class="banner-controls" style="position:absolute; right:8px; bottom:8px; z-index:3; display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
        <select id="langSelector" style="background:#fff;padding:4px 8px;border-radius:4px;border:1px solid #e6e9ef;cursor:pointer;font-size:14px;opacity:0.7;">
          <option value="es">ðŸ‡ªðŸ‡¸</option>
          <option value="en">ðŸ‡¬ðŸ‡§</option>
        </select>
      </div>
    </header>

  <div class="card chat" aria-live="polite" style="display:flex;flex-direction:row;gap:24px;align-items:stretch">
    <div class="lower-section" style="display:flex;flex-direction:row;justify-content:center;align-items:stretch;width:1136px;margin:0 auto;gap:32px;">
      <div class="boton-envio" style="width:568px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafc;border-radius:16px;box-shadow:0 2px 12px #001f3f14;padding:32px 24px;">
        <div class="dialogo-chat" style="width:100%;height:100%;min-height:540px;max-height:540px;overflow-y:auto;background:#fff;border-radius:10px;box-shadow:0 1px 6px #001f3f18;padding:24px 18px 12px 18px;margin-bottom:0;display:flex;flex-direction:column;justify-content:flex-end;gap:10px;">
          <div class="bot-window" id="chatWindow" role="log" aria-atomic="false" style="width:100%;height:100%;min-height:420px;max-height:420px;overflow-y:hidden;"></div>
          <div class="entrada-chat" style="width:100%;display:flex;align-items:end;gap:6px;margin-top:24px;">
            <input id="userInput" type="text" placeholder="Escribe tu respuesta aquÃ­..." style="flex:1;padding:12px 14px;font-size:15px;border-radius:7px;border:1px solid #d1d5db;" />
            <button id="sendBtn" style="padding:6px 8px;font-size:15px;min-width:32px;min-height:32px;max-width:32px;max-height:32px;background:#001f3f;color:#fff;border:none;border-radius:50%;box-shadow:0 1px 4px #001f3f22;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;">ðŸ“¤</button>
          </div>
          <div id="resetContainer" style="width:100%;display:flex;justify-content:flex-end;margin-top:2px;">
            <button id="resetBtn" class="ghost" title="Reiniciar chat" style="padding:2px 4px;font-size:12px;min-width:22px;min-height:22px;max-width:22px;max-height:22px;display:flex;align-items:center;justify-content:center;">ðŸ”„</button>
          </div>
        </div>
      </div>
      <div class="resumen-corto" style="width:568px;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#fff;border-radius:16px;box-shadow:0 2px 12px #001f3f14;padding:32px 24px;">
        <h3 id="summaryTitle" style="margin-bottom:16px;font-size:1.5rem;color:#001f3f;font-weight:700;letter-spacing:0.5px;">Resumen rÃ¡pido</h3>
        <div id="summary" class="muted" style="width:100%;min-height:48px;font-size:1.1rem;color:#333;background:#f3f6fa;border-radius:8px;padding:16px 12px;margin-bottom:18px;box-shadow:0 1px 4px #001f3f0a;">AÃºn no hay datos.</div>
        <div style="width:100%;margin-top:12px;">
          <label class="muted" id="linkedinLabel" style="font-size:0.95rem;">LinkedIn</label>
          <div class="links-row" style="display:flex;gap:8px;margin-top:6px;">
            <input id="linkedinPersonal" type="text" placeholder="LinkedIn personal" style="flex:1;padding:8px 10px;border-radius:6px;border:1px solid #d1d5db;" />
            <input id="linkedinEmpresa" type="text" placeholder="LinkedIn de la empresa" style="flex:1;padding:8px 10px;border-radius:6px;border:1px solid #d1d5db;" />
          </div>
        </div>
        <div style="width:100%;margin-top:12px;">
          <label class="muted" id="newsletterMainLabel" style="font-size:0.95rem;">Â¿Ya estÃ¡s suscrito a mi Newsletter? <a href="https://www.barcelona-metropolitan.com/magazine/newsletter" target="_blank" rel="noopener" style="color:#0074d9;text-decoration:underline;">SuscrÃ­bete aquÃ­</a></label>
          <div style="margin-top:6px;">
            <label style="font-size:0.95rem;"><input id="newsletter" type="checkbox" /> SÃ­, estoy suscrito</label>
          </div>
        </div>
        <div style="width:100%;margin-top:12px;">
          <label class="muted" id="gdprLabelElement" style="font-size:0.95rem;">Consentimiento (obligatorio)</label>
          <div class="consent" style="margin-top:4px;">
            <label style="font-size:0.95rem;"><input id="gdpr" type="checkbox" /> Acepto que mis datos sean tratados por la entidad responsable de esta landing conforme al Reglamento (UE) 2016/679 y la legislaciÃ³n aplicable. Entiendo que puedo ejercer mis derechos de acceso, rectificaciÃ³n, supresiÃ³n y oposiciÃ³n.</label>
          </div>
        </div>
        <div class="footer-actions" style="width:100%;display:flex;gap:8px;margin-top:18px;">
          <button id="btnCopy" class="ghost" style="display:none">Copiar JSON</button>
          <button id="btnDownload" class="ghost" style="display:none">Descargar JSON</button>
          <button id="btnMail" class="ghost" style="background:#001f3f;color:#fff;border-radius:8px;padding:10px 18px;font-size:1rem;box-shadow:0 1px 4px #001f3f22;">Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:14px;display:none !important" class="muted">Puedes personalizar textos, colores y el comportamiento del botÃ³n de envÃ­o en el cÃ³digo.</div>
</div>

<script>
// --- Estilos de burbujas tipo bot ---
const style = document.createElement('style');
style.innerHTML = `
  .msg.bot {
    display: flex;
    justify-content: flex-start;
  }
  .msg.bot .bubble {
    background: #0074d9;
    color: #fff;
    border-radius: 16px 16px 16px 4px;
    padding: 12px 18px;
    margin: 4px 0 6px 0;
    font-size: 1.08rem;
    box-shadow: 0 2px 8px #001f3f18;
    max-width: 90%;
    display: inline-block;
    text-align: left;
    align-self: flex-start;
  }
  .msg.user {
    display: flex;
    justify-content: flex-end;
  }
  .msg.user .bubble.user {
    background: #f3f6fa;
    color: #222;
    border-radius: 16px 16px 4px 16px;
    padding: 12px 18px;
    margin: 6px 0;
    font-size: 1.08rem;
    box-shadow: 0 2px 8px #001f3f10;
    max-width: 90%;
    display: inline-block;
    text-align: right;
    align-self: flex-end;
  }
`;
document.head.appendChild(style);
/* --- Sistema de idiomas --- */
let currentLang = 'es';

const translations = {
  es: {
    introPrompt: 'AyÃºdanos a comprender la naturaleza de tu solicitud para que podamos preparar el proceso y responder de manera oportuna y eficaz.',
    welcome: 'Hola ðŸ‘‹ Soy el asistente de Victor. Â¿CÃ³mo te llamas?',
    nombre: 'Nombre',
    apellido: 'Apellido',
    email: 'Correo electrÃ³nico',
    telefono: 'TelÃ©fono',
    empresa: 'Nombre de la empresa (opcional)',
    target: 'Describe tu pÃºblico objetivo (ej: pymes, consumidores 25-40, B2B)',
    targetGeografico: 'PÃºblico objetivo geogrÃ¡fico (ej: Barcelona, EspaÃ±a, Europa)',
    ayudaQuestion: 'Â¿QuÃ© tipo de apoyo o soluciones beneficiarÃ­an mÃ¡s a tu proyecto?',
    ayudaOptions: [
      'Salud, bienestar y belleza',
      'ExpansiÃ³n internacional',
      'CaptaciÃ³n de capital',
      'BÃºsqueda de inversores',
      'Compradores potenciales',
      'Distribuidores potenciales',
      'Donaciones a ONG',
      'Asesor de confianza',
      'Soluciones de pago',
      'AuditorÃ­a comercial',
      'Desarrollo de software',
      'Apoyo en negociaciones',
      'ConstituciÃ³n de empresas',
      'InmigraciÃ³n y derecho de familia',
      'BÃºsqueda de talento',
      'Impuestos y gestiÃ³n patrimonial',
      'EducaciÃ³n internacional',
      'Fusiones y adquisiciones'
    ],
    compromisoQuestion: 'Â¿En quÃ© etapa te encuentras actualmente?',
    compromisoOptions: ['Investigando opciones', 'BÃºsqueda activa', 'Buscando inversiÃ³n', 'Buscando clientes'],
    resumenAyudaText: 'CuÃ©ntanos brevemente quÃ© tipo de apoyo necesitas (opcional)',
    resumenAyudaQuestion: 'Â¿Deseas aÃ±adir detalles adicionales sobre tus necesidades especÃ­ficas? (opcional)',
    confirm: 'Â¡Perfecto! Antes de finalizar, completa los campos de LinkedIn si lo deseas y acepta el consentimiento GDPR en la columna derecha.',
    end: 'Una vez aceptes el consentimiento, haz clic en Enviar o descarga los datos.',
    selectOptions: 'Selecciona tus opciones y luego haz clic en Enviar.',
    useButtons: 'Por favor utiliza los botones mostrados en el chat para responder esta pregunta.',
    requiredField: 'Este campo es obligatorio.',
    validEmail: 'Introduce un correo electrÃ³nico vÃ¡lido.',
    selectAtLeastOne: 'Por favor selecciona al menos una opciÃ³n.',
    summary: 'Resumen rÃ¡pido',
    noData: 'AÃºn no hay datos.',
    linkedinLabel: 'LinkedIn',
    linkedinPersonalPh: 'LinkedIn personal',
    linkedinEmpresaPh: 'LinkedIn de la empresa',
    newsletterLabel: 'Por favor confirma si estÃ¡s suscrito a nuestro Newsletter (boletÃ­n) (obligatorio)',
    newsletterLink: 'SuscrÃ­bete aquÃ­',
    newsletterCheck: 'SÃ­, confirmo que estoy suscrito al Newsletter (boletÃ­n)',
    gdprLabel: 'Consentimiento (obligatorio)',
    gdprText: 'Acepto que mis datos sean tratados por la entidad responsable de esta landing de conformidad con el Reglamento (UE) 2016/679 y la legislaciÃ³n aplicable. Entiendo que puedo ejercer mis derechos de acceso, rectificaciÃ³n, supresiÃ³n y oposiciÃ³n.',
    summaryLabel: 'Resumen rÃ¡pido',
    newsletterLabelMain: 'Â¿EstÃ¡s suscrito a mi Newsletter (boletÃ­n)?',
    btnMail: 'Enviar',
    sendPlaceholder: 'Escribe tu respuesta aquÃ­...',
    sendBtn: 'ðŸ“¤',
    resetBtn: 'ðŸ”„',
    botHelper: 'El bot te guiarÃ¡ paso a paso. Puedes editar los datos directamente en el resumen o reiniciar con ðŸ”„',
    gdprRequired: 'Debes aceptar el consentimiento GDPR antes de enviar.',
    sentConfirm: 'âœ“ InformaciÃ³n enviada a Victor. Se pondrÃ¡ en contacto contigo en breve. La pÃ¡gina se reiniciarÃ¡.',
    resetConfirm: 'Â¿Seguro que quieres reiniciar el chat? Se perderÃ¡n todos los datos.',
    selectedPrefix: 'Seleccionaste:',
    pleaseEnter: 'Por favor proporciona tu'
  },
  en: {
    introPrompt: 'Help us understand the nature of your request so we can prepare and respond promptly and effectively.',
    welcome: 'Hello ðŸ‘‹ I\'m Victor\'s assistant. What is your name?',
    nombre: 'First name',
    apellido: 'Last name',
    email: 'Email address',
    telefono: 'Phone number',
    empresa: 'Company name (optional)',
    target: 'Describe your target audience (e.g., SMEs, consumers 25-40, B2B)',
    targetGeografico: 'Primary geographic target (e.g., Barcelona, Spain, Europe)',
    ayudaQuestion: 'What type of support or solutions would best benefit your project?',
    ayudaOptions: [
      'Health, wellness and beauty',
      'International expansion',
      'Capital raising',
      'Investor search',
      'Potential buyers',
      'Potential distributors',
      'NGO donations',
      'Trusted advisor',
      'Payment solutions',
      'Commercial due diligence',
      'Software development',
      'Negotiation support',
      'Corporate setup',
      'Immigration and family law',
      'Talent acquisition',
      'Tax and wealth management',
      'International education',
      'Mergers and acquisitions'
    ],
    compromisoQuestion: 'What stage are you currently at?',
    compromisoOptions: ['Researching options', 'Actively seeking', 'Seeking investment', 'Looking for clients'],
    resumenAyudaText: 'Briefly describe what kind of support you need (optional)',
    resumenAyudaQuestion: 'Would you like to add any additional details about your specific requirements? (optional)',
    confirm: 'Perfect! Before submitting, please complete the LinkedIn fields if desired and accept the GDPR consent in the right column.',
    end: 'Once you accept the consent, click Submit or download the data.',
    selectOptions: 'Select your options and then click Send.',
    useButtons: 'Please use the buttons displayed in the chat to answer this question.',
    requiredField: 'This field is required.',
    validEmail: 'Please enter a valid email address.',
    selectAtLeastOne: 'Please select at least one option.',
    summary: 'Quick summary',
    noData: 'No data yet.',
    linkedinLabel: 'LinkedIn',
    linkedinPersonalPh: 'Personal LinkedIn',
    linkedinEmpresaPh: 'Company LinkedIn',
    newsletterLabel: 'Are you subscribed to our newsletter? (required)',
    newsletterLink: 'Subscribe here',
    newsletterCheck: 'Yes, I confirm I am subscribed to the newsletter',
    gdprLabel: 'Consent (required)',
    gdprText: 'I accept that my data will be processed by the entity responsible for this landing page in accordance with Regulation (EU) 2016/679 and applicable legislation. I understand that I can exercise my rights of access, rectification, deletion and opposition.',
    summaryLabel: 'Quick summary',
    newsletterLabelMain: 'Are you subscribed to my newsletter?',
    btnMail: 'Submit',
    sendPlaceholder: 'Type your answer here...',
    sendBtn: 'ðŸ“¤',
    resetBtn: 'ðŸ”„',
    botHelper: '',
    gdprRequired: 'You must accept the GDPR consent before submitting.',
    sentConfirm: 'âœ“ Information sent to Victor. He will get in touch with you shortly. The page will restart.',
    resetConfirm: 'Are you sure you want to restart the chat? All data will be lost.',
    selectedPrefix: 'You selected:',
    pleaseEnter: 'Please provide your'
  }
};

/* --- Datos y flujo del bot --- */
const state = {
  nombre: '', apellido: '', email: '', telefono: '', empresa: '', target: '', targetGeografico: '',
  ayuda: [], compromiso: '', resumenAyuda: '', newsletter: false, linkedinPersonal:'', linkedinEmpresa:'', gdpr:false
};

function getSteps() {
  const t = translations[currentLang];
  return [
    {id:'intro', type:'bot', text: t.introPrompt},
    {id:'welcome', type:'bot', text: t.welcome},
    {id:'nombre', type:'input', key:'nombre', placeholder: t.nombre},
    {id:'apellido', type:'input', key:'apellido', placeholder: t.apellido},
    {id:'email', type:'input', key:'email', placeholder: t.email, validate:'email'},
    {id:'telefono', type:'input', key:'telefono', placeholder: t.telefono},
    {id:'empresa', type:'input', key:'empresa', placeholder: t.empresa},
    {id:'target', type:'input', key:'target', placeholder: t.target},
    {id:'targetGeografico', type:'input', key:'targetGeografico', placeholder: t.targetGeografico},
    {id:'ayuda', type:'options', key:'ayuda', text: t.ayudaQuestion, options: t.ayudaOptions},
    {id:'compromiso', type:'select', key:'compromiso', text: t.compromisoQuestion, options: t.compromisoOptions},
    {id:'resumenAyuda', type:'input', key:'resumenAyuda', placeholder: t.resumenAyudaText, text: t.resumenAyudaQuestion},
    {id:'confirm', type:'bot', text: t.confirm},
    {id:'end', type:'bot', text: t.end}
  ];
}

let steps = getSteps();

let stepIndex = 0;
const chatWindow = document.getElementById('chatWindow');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const summaryEl = document.getElementById('summary');
const linkedinPersonal = document.getElementById('linkedinPersonal');
const linkedinEmpresa = document.getElementById('linkedinEmpresa');

function appendBot(text){
  const div = document.createElement('div'); div.className='message msg bot';
  const b = document.createElement('div'); b.className='bubble'; b.innerHTML = text;
  div.appendChild(b); chatWindow.appendChild(div); chatWindow.scrollTop = chatWindow.scrollHeight;
}
function appendUser(text){
  const div = document.createElement('div'); div.className='message msg user';
  const b = document.createElement('div'); b.className='bubble user'; b.innerText = text;
  div.appendChild(b); chatWindow.appendChild(div); chatWindow.scrollTop = chatWindow.scrollHeight;
}

function renderStep(){
  const s = steps[stepIndex];
  if(!s) return;
  if(s.type === 'bot'){
    appendBot(s.text);
    stepIndex++;
    setTimeout(renderStep,600);
    return;
  }
  if(s.type === 'input'){
    let displayText = s.text;
    const t = translations[currentLang];
    // Personalizar mensaje de resumen segÃºn opciones de ayuda seleccionadas
    if(s.key === 'resumenAyuda' && state.ayuda && state.ayuda.length > 0){
      displayText = `${t.selectedPrefix} ${state.ayuda.join(', ')}. ${t.resumenAyudaQuestion}`;
    }
    appendBot(displayText || (t.pleaseEnter + ' ' + s.placeholder));
    userInput.placeholder = s.placeholder || '';
    userInput.focus();
  } else if(s.type === 'options'){
    appendBot(s.text);
    // render option buttons inside chat
    const container = document.createElement('div'); container.className='options'; container.style.margin='8px 0';
    s.options.forEach(opt=>{
      const btn = document.createElement('button'); btn.className='option-btn'; btn.innerText=opt;
      btn.onclick = ()=> {
        // toggle selection
        if(!state[s.key]) state[s.key]=[];
        const arr = state[s.key];
        const idx = arr.indexOf(opt);
        if(idx===-1){ arr.push(opt); btn.classList.add('active'); }
        else { arr.splice(idx,1); btn.classList.remove('active'); }
        updateSummary();
      };
      container.appendChild(btn);
    });
    chatWindow.appendChild(container); chatWindow.scrollTop = chatWindow.scrollHeight;
    // show instruction to press enviar cuando termine
    const t = translations[currentLang];
    appendBot(t.selectOptions);
  } else if(s.type === 'select'){
    appendBot(s.text);
    const container = document.createElement('div'); container.style.margin='8px 0';
    s.options.forEach(opt=>{
      const btn = document.createElement('button'); btn.className='option-btn'; btn.innerText=opt;
      btn.onclick = ()=> {
        state[s.key]=opt;
        appendUser(opt);
        updateSummary();
        stepIndex++;
        setTimeout(renderStep,400);
      };
      container.appendChild(btn);
    });
    chatWindow.appendChild(container); chatWindow.scrollTop = chatWindow.scrollHeight;
  }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSend(); });

document.getElementById('resetBtn').addEventListener('click', ()=>{
  const t = translations[currentLang];
  if(confirm(t.resetConfirm)){
    location.reload();
  }
});

function handleSend(){
  const s = steps[stepIndex];
  const text = userInput.value.trim();
  const t = translations[currentLang];
  if(!s) return;
  if(s.type === 'input'){
    const requiredInputs = ['nombre','apellido','email','telefono'];
    if(requiredInputs.includes(s.key) && !text){
      alert(t.requiredField);
      return;
    }
    if(s.validate === 'email' && !/^\S+@\S+\.\S+$/.test(text)){
      alert(t.validEmail);
      return;
    }
    appendUser(text || '(sin respuesta)');
    state[s.key]=text;
    userInput.value=''; stepIndex++; updateSummary();
    setTimeout(renderStep,400);
  } else if(s.type === 'options'){
    // for multiple options, check if at least one is selected
    if(!state[s.key] || state[s.key].length === 0){
      alert(t.selectAtLeastOne);
      return;
    }
    appendUser(state[s.key].join(', '));
    stepIndex++;
    setTimeout(renderStep,400);
  } else {
    // for select type, instruct to use buttons
    alert(t.useButtons);
  }
}

function updateSummary(){
  const parts = [];
  if(state.nombre) parts.push('<strong>Nombre:</strong> <span contenteditable="true" class="editable" data-key="nombre">'+escapeHtml(state.nombre)+'</span>');
  if(state.apellido) parts.push('<strong>Apellido:</strong> <span contenteditable="true" class="editable" data-key="apellido">'+escapeHtml(state.apellido)+'</span>');
  if(state.email) parts.push('<strong>Email:</strong> <span contenteditable="true" class="editable" data-key="email">'+escapeHtml(state.email)+'</span>');
  if(state.telefono) parts.push('<strong>Tel:</strong> <span contenteditable="true" class="editable" data-key="telefono">'+escapeHtml(state.telefono)+'</span>');
  if(state.empresa) parts.push('<strong>Empresa:</strong> <span contenteditable="true" class="editable" data-key="empresa">'+escapeHtml(state.empresa)+'</span>');
  if(state.target) parts.push('<strong>Target:</strong> <span contenteditable="true" class="editable" data-key="target">'+escapeHtml(state.target)+'</span>');
  if(state.targetGeografico) parts.push('<strong>Target GeogrÃ¡fico:</strong> <span contenteditable="true" class="editable" data-key="targetGeografico">'+escapeHtml(state.targetGeografico)+'</span>');
  if(state.ayuda && state.ayuda.length) parts.push('<strong>Ayuda:</strong> '+escapeHtml(state.ayuda.join('; ')));
  if(state.compromiso) parts.push('<strong>Compromiso:</strong> '+escapeHtml(state.compromiso));
  if(state.resumenAyuda) parts.push('<strong>Resumen:</strong> <span contenteditable="true" class="editable" data-key="resumenAyuda">'+escapeHtml(state.resumenAyuda)+'</span>');
  summaryEl.innerHTML = parts.length ? parts.join('<br/>') : 'AÃºn no hay datos.';

  // Attach listeners to editable fields
  document.querySelectorAll('.editable').forEach(el=>{
    el.addEventListener('blur', function(){
      const key = this.dataset.key;
      state[key] = this.innerText.trim();
    });
  });
}

/* copy / download / mail */
document.getElementById('btnCopy').addEventListener('click', ()=>{
  collectExtras();
  const gdpr = document.getElementById('gdpr');
  if(!gdpr.checked){ alert('Debes aceptar el consentimiento GDPR antes de copiar/enviar.'); return; }
  const json = JSON.stringify(state, null, 2);
  navigator.clipboard.writeText(json).then(()=>alert('JSON copiado al portapapeles.'));
});
document.getElementById('btnDownload').addEventListener('click', ()=>{
  collectExtras();
  const gdpr = document.getElementById('gdpr');
  if(!gdpr.checked){ alert('Debes aceptar el consentimiento GDPR antes de copiar/enviar.'); return; }
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'datos-landing.json'; a.click();
});
document.getElementById('btnMail').addEventListener('click', async ()=>{
  collectExtras();
  const t = translations[currentLang];
  const gdpr = document.getElementById('gdpr');
  if(!gdpr.checked){ alert(t.gdprRequired); return; }

  const btn = document.getElementById('btnMail');
  const prevText = btn.innerText;
  btn.disabled = true;
  btn.innerText = currentLang === 'en' ? 'Sendingâ€¦' : 'Enviandoâ€¦';

  const subjectText = 'URGENTE - Contacto desde landing: ' + (state.nombre || 'sin nombre');
  const payload = {
    _subject: subjectText,
    _replyto: state.email || '',
    nombre: state.nombre,
    apellido: state.apellido,
    email: state.email,
    telefono: state.telefono,
    empresa: state.empresa,
    target: state.target,
    targetGeografico: state.targetGeografico,
    ayuda: (state.ayuda || []).join(', '),
    compromiso: state.compromiso,
    resumenAyuda: state.resumenAyuda,
    linkedinPersonal: state.linkedinPersonal,
    linkedinEmpresa: state.linkedinEmpresa,
    newsletter: state.newsletter ? 'sÃ­' : 'no',
    gdpr: state.gdpr ? 'aceptado' : 'no-aceptado',
    full_json: JSON.stringify(state)
  };

  const ok = await sendToFormspree(payload);
  if(ok){
    alert(t.sentConfirm);
    setTimeout(()=>{ location.reload(); }, 500);
  } else {
    const errorMsg = currentLang === 'en' ? 'There was a problem sending the data.' : 'Hubo un problema al enviar los datos.';
    alert(errorMsg);
    btn.disabled = false;
    btn.innerText = prevText;
  }
});

function collectExtras(){
  state.linkedinPersonal = linkedinPersonal.value.trim();
  state.linkedinEmpresa = linkedinEmpresa.value.trim();
  state.newsletter = document.getElementById('newsletter').checked;
  state.gdpr = document.getElementById('gdpr').checked;
}

/* --- EnvÃ­o a Formspree --- */
const FORMSPREE_ENDPOINT = "https://formspree.io/f/xlgelvvq";

async function sendToFormspree(data) {
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(data)
    });

    // Try to extract diagnostic info from Formspree
    let info = {};
    try { info = await res.json(); } catch {}
    console.log('[Formspree] status:', res.status, 'info:', info);

    if (res.ok) {
      return true;
    } else {
      // Surface useful errors to help debugging in production
      const msg = info && (info.error || info.message);
      alert(msg ? ('Formspree: ' + msg) : (currentLang === 'en' ? 'Form submit failed.' : 'Fallo al enviar el formulario.'));
      return false;
    }
  } catch (e) {
    console.error('[Formspree] network error:', e);
    alert(currentLang === 'en' ? 'Network error sending the form.' : 'Error de red al enviar el formulario.');
    return false;
  }
}

/* helper */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* Language selector */
document.getElementById('langSelector').addEventListener('change', (e)=>{
  currentLang = e.target.value;
  // Sync mobile selector too
  const mobileLangSelector = document.getElementById('langSelectorMobile');
  if(mobileLangSelector) mobileLangSelector.value = currentLang;
  steps = getSteps();
  updateUILanguage();
  // restart chat with new language
  chatWindow.innerHTML = '';
  stepIndex = 0;
  renderStep();
});

// Mobile language selector sync
const mobileLangSelector = document.getElementById('langSelectorMobile');
if(mobileLangSelector){
  mobileLangSelector.addEventListener('change', (e)=>{
    currentLang = e.target.value;
    document.getElementById('langSelector').value = currentLang;
    steps = getSteps();
    updateUILanguage();
    chatWindow.innerHTML = '';
    stepIndex = 0;
    renderStep();
  });
}

function updateUILanguage(){
  const t = translations[currentLang];
  document.getElementById('userInput').placeholder = t.sendPlaceholder;
  document.getElementById('sendBtn').innerText = t.sendBtn;
  document.getElementById('summaryTitle').innerText = t.summaryLabel;
  document.querySelector('h3').innerText = t.summary;

  // Update newsletter main label
  const newsletterMainLabel = document.getElementById('newsletterMainLabel');
  if(newsletterMainLabel) {
    newsletterMainLabel.innerHTML = `${t.newsletterLabelMain} <a href="https://www.barcelona-metropolitan.com/magazine/newsletter" target="_blank" rel="noopener">${t.newsletterLink}</a>`;
  }

  // Update GDPR label element
  const gdprLabelElement = document.getElementById('gdprLabelElement');
  if(gdprLabelElement) {
    gdprLabelElement.innerText = t.gdprLabel;
  }

  // Update LinkedIn label and placeholders
  const linkedinLabelEl = document.getElementById('linkedinLabel');
  if(linkedinLabelEl) linkedinLabelEl.innerText = t.linkedinLabel;

  document.getElementById('linkedinPersonal').placeholder = t.linkedinPersonalPh;
  document.getElementById('linkedinEmpresa').placeholder = t.linkedinEmpresaPh;

  // Update GDPR label text preserving the checkbox
  const gdprCheckbox = document.getElementById('gdpr');
  const gdprChecked = gdprCheckbox ? gdprCheckbox.checked : false;
  document.querySelector('.consent label').innerHTML = `<input id="gdpr" type="checkbox" ${gdprChecked ? 'checked' : ''} /> ${t.gdprText}`;

  document.getElementById('btnMail').innerText = t.btnMail;

  // Update newsletter checkbox label
  const newsletterCheckbox = document.getElementById('newsletter');
  const newsletterChecked = newsletterCheckbox ? newsletterCheckbox.checked : false;
  newsletterCheckbox.parentElement.innerHTML = `<input id="newsletter" type="checkbox" ${newsletterChecked ? 'checked' : ''} /> ${t.newsletterCheck}`;
  updateSummary();
}

/* inicializa */
updateUILanguage();
renderStep();
updateSummary();
</script>
</body>
</html>
